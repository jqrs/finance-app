{% extends "base.html" %}

{% block title %}Transactions - Finance App{% endblock %}

{% block content %}
<div x-data="transactionsPage()" x-init="init()">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-900">Transactions</h1>
        <button @click="showAddModal = true"
                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
            Add Transaction
        </button>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Account</label>
                <select x-model="filters.account_id" @change="loadTransactions()"
                        class="w-full border-gray-300 rounded-md shadow-sm">
                    <option value="">All Accounts</option>
                    <template x-for="account in accounts" :key="account.id">
                        <option :value="account.id" x-text="account.name"></option>
                    </template>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                <select x-model="filters.category_id" @change="loadTransactions()"
                        class="w-full border-gray-300 rounded-md shadow-sm">
                    <option value="">All Categories</option>
                    <template x-for="category in categories" :key="category.id">
                        <option :value="category.id" x-text="category.name"></option>
                    </template>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                <input type="date" x-model="filters.start_date" @change="loadTransactions()"
                       class="w-full border-gray-300 rounded-md shadow-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                <input type="date" x-model="filters.end_date" @change="loadTransactions()"
                       class="w-full border-gray-300 rounded-md shadow-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                <input type="text" x-model="filters.search" @input.debounce.300ms="loadTransactions()"
                       placeholder="Search descriptions..."
                       class="w-full border-gray-300 rounded-md shadow-sm">
            </div>
        </div>
    </div>

    <!-- Transactions Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Account</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Amount</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                <template x-for="txn in transactions" :key="txn.id">
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="txn.date"></td>
                        <td class="px-6 py-4 text-sm text-gray-900">
                            <div x-text="txn.description"></div>
                            <div x-show="txn.merchant" class="text-xs text-gray-500" x-text="txn.merchant"></div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <select @change="updateCategory(txn.id, $event.target.value)"
                                    class="text-sm border-gray-300 rounded-md">
                                <option value="">Uncategorized</option>
                                <template x-for="cat in categories" :key="cat.id">
                                    <option :value="cat.id"
                                            :selected="txn.category_id == cat.id"
                                            x-text="cat.name"></option>
                                </template>
                            </select>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                            x-text="txn.account?.name || '-'"></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium"
                            :class="txn.amount >= 0 ? 'text-green-600' : 'text-red-600'"
                            x-text="formatCurrency(txn.amount)"></td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                            <button @click="deleteTransaction(txn.id)"
                                    class="text-red-600 hover:text-red-800">Delete</button>
                        </td>
                    </tr>
                </template>
                <tr x-show="transactions.length === 0">
                    <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                        No transactions found. <a href="/import" class="text-blue-600">Import some data</a> or add a transaction manually.
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Add Transaction Modal -->
    <div x-show="showAddModal" x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6" @click.away="showAddModal = false">
            <h2 class="text-lg font-semibold mb-4">Add Transaction</h2>
            <form @submit.prevent="addTransaction()">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Account</label>
                        <select x-model="newTransaction.account_id" required
                                class="mt-1 w-full border-gray-300 rounded-md shadow-sm">
                            <option value="">Select account...</option>
                            <template x-for="account in accounts" :key="account.id">
                                <option :value="account.id" x-text="account.name"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" x-model="newTransaction.date" required
                               class="mt-1 w-full border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Description</label>
                        <input type="text" x-model="newTransaction.description" required
                               class="mt-1 w-full border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Amount (negative for expense)</label>
                        <input type="number" step="0.01" x-model="newTransaction.amount" required
                               class="mt-1 w-full border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Category</label>
                        <select x-model="newTransaction.category_id"
                                class="mt-1 w-full border-gray-300 rounded-md shadow-sm">
                            <option value="">Uncategorized</option>
                            <template x-for="cat in categories" :key="cat.id">
                                <option :value="cat.id" x-text="cat.name"></option>
                            </template>
                        </select>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" @click="showAddModal = false"
                            class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit"
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Add
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function transactionsPage() {
    return {
        transactions: [],
        accounts: [],
        categories: [],
        filters: {
            account_id: '',
            category_id: '',
            start_date: '',
            end_date: '',
            search: ''
        },
        showAddModal: false,
        newTransaction: {
            account_id: '',
            date: new Date().toISOString().split('T')[0],
            description: '',
            amount: '',
            category_id: ''
        },

        async init() {
            await Promise.all([
                this.loadAccounts(),
                this.loadCategories(),
                this.loadTransactions()
            ]);
        },

        async loadAccounts() {
            const res = await fetch('/api/accounts');
            this.accounts = await res.json();
        },

        async loadCategories() {
            const res = await fetch('/api/categories');
            this.categories = await res.json();
        },

        async loadTransactions() {
            const params = new URLSearchParams();
            if (this.filters.account_id) params.append('account_id', this.filters.account_id);
            if (this.filters.category_id) params.append('category_id', this.filters.category_id);
            if (this.filters.start_date) params.append('start_date', this.filters.start_date);
            if (this.filters.end_date) params.append('end_date', this.filters.end_date);
            if (this.filters.search) params.append('search', this.filters.search);

            const res = await fetch(`/api/transactions?${params}`);
            this.transactions = await res.json();
        },

        async addTransaction() {
            const data = {
                ...this.newTransaction,
                amount: parseFloat(this.newTransaction.amount),
                category_id: this.newTransaction.category_id || null
            };

            const res = await fetch('/api/transactions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                this.showAddModal = false;
                this.newTransaction = {
                    account_id: '',
                    date: new Date().toISOString().split('T')[0],
                    description: '',
                    amount: '',
                    category_id: ''
                };
                await this.loadTransactions();
            }
        },

        async updateCategory(transactionId, categoryId) {
            await fetch(`/api/transactions/${transactionId}/category?category_id=${categoryId || ''}`, {
                method: 'PATCH'
            });
            await this.loadTransactions();
        },

        async deleteTransaction(id) {
            if (!confirm('Delete this transaction?')) return;

            await fetch(`/api/transactions/${id}`, { method: 'DELETE' });
            await this.loadTransactions();
        },

        formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount || 0);
        }
    };
}
</script>
{% endblock %}
